apply plugin: 'org.jetbrains.kotlin.jvm'
apply plugin: 'org.jetbrains.kotlin.kapt'
apply plugin: 'org.jetbrains.grammarkit'

test {
  testLogging {
    events "passed", "skipped", "failed"
    exceptionFormat "full"
    showExceptions true
    showStackTraces true
    showCauses true
  }
}

sourceSets {
  main.java.srcDir "src/generated/kotlin"
}

dependencies {
  api deps.sqlitePsi

  implementation deps.kotlinPoet
  implementation deps.kotlin.stdlib.jdk
  implementation deps.moshi
  kapt deps.moshiKotlinCodegen

  // Required by intellij core
  compileOnly deps.guava
  compileOnly deps.intellijCore
  compileOnly deps.intellijJavaPlugin

  testImplementation deps.intellijCore
  testImplementation deps.intellijJavaPlugin
  testImplementation deps.junit
  testImplementation deps.truth
  testImplementation project(':test-util')
}

task pluginVersion {
  def outputDir = file("src/generated/kotlin")

  inputs.property 'version', version
  outputs.dir outputDir

  doLast {
    def versionFile = file("$outputDir/com/squareup/sqldelight/Version.kt")
    versionFile.parentFile.mkdirs()
    versionFile.text = """// Generated file. Do not edit!
package com.squareup.sqldelight

val VERSION = "${project.version}"
"""
  }
}

import org.jetbrains.grammarkit.tasks.GenerateParser

task generateSqlDelightParser(type: GenerateParser) {
  source "src/main/grammars/sqldelight.bnf"
  targetRoot = 'src/generated/kotlin/'
  pathToParser '/com/squareup/sqldelight/core/parser/SampleParser.java'
  pathToPsiRoot '/com/squareup/sqldelight/core/psi'
  purgeOldFiles = true
}

tasks.getByName('compileKotlin').dependsOn('pluginVersion')
tasks.getByName('compileKotlin').dependsOn('generateSqlDelightParser')
tasks.named('generateSqlDelightParser').configure {
  dependsOn(':unzipIntellij')
}

apply from: "$rootDir/gradle/gradle-mvn-push.gradle"
